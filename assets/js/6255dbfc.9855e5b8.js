"use strict";(self.webpackChunkgolioth_thread_demo=self.webpackChunkgolioth_thread_demo||[]).push([[485],{3905:function(e,t,n){n.d(t,{Zo:function(){return d},kt:function(){return p}});var r=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},i=Object.keys(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var u=r.createContext({}),s=function(e){var t=r.useContext(u),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},d=function(e){var t=s(e.components);return r.createElement(u.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},h=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,i=e.originalType,u=e.parentName,d=l(e,["components","mdxType","originalType","parentName"]),h=s(n),p=a,f=h["".concat(u,".").concat(p)]||h[p]||c[p]||i;return n?r.createElement(f,o(o({ref:t},d),{},{components:n})):r.createElement(f,o({ref:t},d))}));function p(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=n.length,o=new Array(i);o[0]=h;var l={};for(var u in t)hasOwnProperty.call(t,u)&&(l[u]=t[u]);l.originalType=e,l.mdxType="string"==typeof e?e:a,o[1]=l;for(var s=2;s<i;s++)o[s]=n[s];return r.createElement.apply(null,o)}return r.createElement.apply(null,n)}h.displayName="MDXCreateElement"},2669:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return l},contentTitle:function(){return u},metadata:function(){return s},assets:function(){return d},toc:function(){return c},default:function(){return p}});var r=n(7462),a=n(3366),i=(n(7294),n(3905)),o=["components"],l={sidebar_position:1},u="Thread Node Code review",s={unversionedId:"create-thread-node/thread-node-code-overview",id:"create-thread-node/thread-node-code-overview",title:"Thread Node Code review",description:"So what is actually happening on the node? You have this code that is running Zephyr, Golioth, OpenThread, but what is it actally doing?",source:"@site/docs/create-thread-node/thread-node-code-overview.md",sourceDirName:"create-thread-node",slug:"/create-thread-node/thread-node-code-overview",permalink:"/golioth-openthread-demo-docs/docs/create-thread-node/thread-node-code-overview",tags:[],version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1},sidebar:"tutorialSidebar",previous:{title:"Create a node on your Thread Network",permalink:"/golioth-openthread-demo-docs/docs/create-thread-node/"}},d={},c=[{value:"Setup code",id:"setup-code",level:2},{value:"Hardware configuration",id:"hardware-configuration",level:3},{value:"OpenThread configuration",id:"openthread-configuration",level:3},{value:"Timer",id:"timer",level:3},{value:"Activating Readings",id:"activating-readings",level:2},{value:"Button Press",id:"button-press",level:3},{value:"Timeout",id:"timeout",level:3},{value:"Taking a reading and transmitting",id:"taking-a-reading-and-transmitting",level:2}],h={toc:c};function p(e){var t=e.components,n=(0,a.Z)(e,o);return(0,i.kt)("wrapper",(0,r.Z)({},h,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"thread-node-code-review"},"Thread Node Code review"),(0,i.kt)("p",null,"So what is actually happening on the node? You have this code that is running Zephyr, Golioth, OpenThread, but what is it actally doing?"),(0,i.kt)("p",null,"Below we will be referring to the BT510, as that is the board that has built-in sensors. "),(0,i.kt)("h2",{id:"setup-code"},"Setup code"),(0,i.kt)("p",null,"Most of the exciting code is happening in RTOS workers. This allows the Zephyr scheduler to prioritize and take over running the code. From our perspective it mostly looks like a function but uses Zephyr primatives to work within the RTOS. "),(0,i.kt)("p",null,"In the main part of the loop we are doing hardware setup first:"),(0,i.kt)("h3",{id:"hardware-configuration"},"Hardware configuration"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Setting up the button"),(0,i.kt)("li",{parentName:"ul"},"Setting up LEDs"),(0,i.kt)("li",{parentName:"ul"},"Setting up sensors",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"Temperature"),(0,i.kt)("li",{parentName:"ul"},"IMU"),(0,i.kt)("li",{parentName:"ul"},"Magnetic")))),(0,i.kt)("h3",{id:"openthread-configuration"},"OpenThread configuration"),(0,i.kt)("p",null,'Then we are configuring "Workers" which are taking action on connecting or disconnecting from the Thread network. '),(0,i.kt)("p",null,"There are also callbacks for when the state of the network changes. This will actuate LEDs."),(0,i.kt)("h3",{id:"timer"},"Timer"),(0,i.kt)("p",null,"Finally, we kick off a timer with a configurable interval (default 60 seconds) so that the node will report its sensor status without any user input. "),(0,i.kt)("h2",{id:"activating-readings"},"Activating Readings"),(0,i.kt)("p",null,"We can get readings from the sensors in two ways:"),(0,i.kt)("h3",{id:"button-press"},"Button Press"),(0,i.kt)("p",null,"If a user actuates the button on the BT510 (underneath the vinyl), it will initiate a reading. This happens in the ",(0,i.kt)("inlineCode",{parentName:"p"},"on_button_changed")," function. At the end of this function, it kicks off the ",(0,i.kt)("inlineCode",{parentName:"p"},"my_sensor_work")," function, where all the readings happen. "),(0,i.kt)("h3",{id:"timeout"},"Timeout"),(0,i.kt)("p",null,"If the configurable timer length gets to the end of its period, it does two things:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Updates the LightDB state variable that keeps track of how many updates there have been by the timer (this acts like a counter of the number of intervals passed)"),(0,i.kt)("li",{parentName:"ul"},"Calls the ",(0,i.kt)("inlineCode",{parentName:"li"},"my_sensor_work")," function.")),(0,i.kt)("h2",{id:"taking-a-reading-and-transmitting"},"Taking a reading and transmitting"),(0,i.kt)("p",null,"Once the ",(0,i.kt)("inlineCode",{parentName:"p"},"my_sensor_work")," function is called, it sets an LED and kicks off the ",(0,i.kt)("inlineCode",{parentName:"p"},"my_sensorstream_work")," function. Inside of that function we:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Take a reading from each sensor",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"Temperature"),(0,i.kt)("li",{parentName:"ul"},"IMU"),(0,i.kt)("li",{parentName:"ul"},"Magnetic"))),(0,i.kt)("li",{parentName:"ul"},"Convert each of these to a string"),(0,i.kt)("li",{parentName:"ul"},"Concatenate them together in JSON format"),(0,i.kt)("li",{parentName:"ul"},"Transmit the entire string to LightDB Stream")))}p.isMDXComponent=!0}}]);